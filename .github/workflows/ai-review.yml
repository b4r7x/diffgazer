name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # Check if this is a command trigger
  check-command:
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment'
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Check for /ai-review command
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.trim();
            const isPR = !!context.payload.issue.pull_request;

            if (isPR && comment === '/ai-review') {
              core.setOutput('should_run', 'true');
              core.setOutput('pr_number', context.payload.issue.number);

              // React to comment
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'rocket',
              });
            } else {
              core.setOutput('should_run', 'false');
            }

  review:
    runs-on: ubuntu-latest
    needs: [check-command]
    if: |
      always() && (
        (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) ||
        (github.event_name == 'issue_comment' && needs.check-command.outputs.should_run == 'true')
      )

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/head', needs.check-command.outputs.pr_number) || '' }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Get PR diff
        env:
          BASE_REF: ${{ github.base_ref }}
          PR_NUMBER: ${{ github.event_name == 'issue_comment' && needs.check-command.outputs.pr_number || github.event.pull_request.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            # For comment triggers, fetch PR info to get base ref
            gh pr view "$PR_NUMBER" --json baseRefName --jq '.baseRefName' > base_ref.txt
            BASE=$(cat base_ref.txt)
            git fetch origin "$BASE"
            git diff "origin/${BASE}...HEAD" > pr.diff
          else
            git diff "origin/${BASE_REF}...HEAD" > pr.diff
          fi
          echo "Diff size: $(wc -l < pr.diff) lines"

      - name: Check diff size
        id: check-diff
        run: |
          DIFF_LINES=$(wc -l < pr.diff)
          if [ "$DIFF_LINES" -eq 0 ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "No changes detected in diff"
          elif [ "$DIFF_LINES" -gt 5000 ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Diff too large ($DIFF_LINES lines), skipping AI review"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Start server
        if: steps.check-diff.outputs.skip != 'true'
        run: |
          npm run -w apps/server start &
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:7860/health > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            sleep 1
          done

      - name: Run AI Review
        id: review
        if: steps.check-diff.outputs.skip != 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Prepare diff content as JSON string
          DIFF_CONTENT=$(cat pr.diff | jq -Rs .)

          # Call review endpoint
          HTTP_CODE=$(curl -s -w "%{http_code}" -o review.json \
            -X POST http://localhost:7860/pr-review \
            -H "Content-Type: application/json" \
            -H "Origin: http://127.0.0.1:7860" \
            -d "{\"diff\": $DIFF_CONTENT, \"profile\": \"strict\"}")

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Review API returned HTTP $HTTP_CODE"
            cat review.json
            exit 1
          fi

          echo "Review completed successfully"

          # Extract annotations for GitHub
          jq '.annotations' review.json > annotations.json

          # Show summary
          echo "## Review Summary"
          jq -r '.summary' review.json
          echo ""
          echo "Found $(jq '.issues | length' review.json) issues"

      - name: Post annotations
        if: steps.check-diff.outputs.skip != 'true'
        uses: yuzutech/annotations-action@v0.5.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          input: annotations.json

      - name: Post PR review with inline comments
        if: always() && steps.review.outcome == 'success'
        env:
          PR_NUMBER: ${{ github.event_name == 'issue_comment' && needs.check-command.outputs.pr_number || github.event.pull_request.number }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            if (!fs.existsSync('review.json')) {
              console.log('No review results found');
              return;
            }

            const review = JSON.parse(fs.readFileSync('review.json', 'utf8'));
            const issueCount = review.issues?.length || 0;
            const prNumber = parseInt(process.env.PR_NUMBER);

            // Filter valid inline comments
            const comments = (review.inlineComments || []).filter(c =>
              c.path && c.line && c.body
            );

            // Determine review event based on severity
            const hasBlocker = review.issues?.some(i => i.severity === 'blocker');
            const hasHigh = review.issues?.some(i => i.severity === 'high');
            const event = hasBlocker ? 'REQUEST_CHANGES' : (hasHigh ? 'COMMENT' : 'APPROVE');

            // Build review body
            let body = `## Stargazer AI Review\n\n`;
            body += `${review.summary}\n\n`;

            if (issueCount > 0) {
              body += `### Issues Found: ${issueCount}\n\n`;

              const bySeverity = {};
              for (const issue of review.issues) {
                bySeverity[issue.severity] = (bySeverity[issue.severity] || 0) + 1;
              }

              body += `| Severity | Count |\n|----------|-------|\n`;
              for (const [severity, count] of Object.entries(bySeverity).sort()) {
                body += `| ${severity} | ${count} |\n`;
              }

              if (comments.length > 0) {
                body += `\n*${comments.length} inline comments posted on specific lines.*\n`;
              }
            } else {
              body += `No issues found.\n`;
            }

            body += `\n---\n*Reviewed by Stargazer AI*`;

            // Post review with inline comments if available
            if (comments.length > 0) {
              try {
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  event: event,
                  body: body,
                  comments: comments.slice(0, 50), // GitHub limit
                });
                console.log(`Posted review with ${comments.length} inline comments`);
              } catch (error) {
                console.error('Failed to post review with inline comments:', error.message);
                // Fallback to regular comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: body,
                });
                console.log('Posted fallback issue comment');
              }
            } else {
              // No inline comments, post as issue comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body,
              });
              console.log('Posted review summary as issue comment (no inline comments)');
            }

  # Separate job for fork PRs - manual trigger only
  review-fork:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository

    steps:
      - name: Fork PR notice
        run: |
          echo "This PR is from a fork. AI review requires manual trigger by a maintainer."
          echo "Use workflow_dispatch to run review with appropriate permissions."
