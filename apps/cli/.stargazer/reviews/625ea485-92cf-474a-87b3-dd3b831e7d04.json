{
  "metadata": {
    "id": "625ea485-92cf-474a-87b3-dd3b831e7d04",
    "projectPath": "/Users/voitz/Projects/stargazer/apps/cli",
    "createdAt": "2026-01-22T19:25:58.510Z",
    "staged": false,
    "branch": "feature/review-bounding",
    "overallScore": 8,
    "issueCount": 5,
    "criticalCount": 1,
    "warningCount": 1,
    "sessionId": null
  },
  "result": {
    "summary": "This PR introduces significant enhancements to the code review workflow, most notably the 'Discuss Review' feature which links AI reviews to chat sessions. It also adds support for 'chunked' reviews (file-by-file progress), improved AI response parsing (handling markdown-wrapped JSON), and configurable token limits. The addition of comprehensive integration tests for storage and the transition to Vitest are excellent improvements to maintainability.",
    "issues": [
      {
        "severity": "critical",
        "category": "logic",
        "file": "apps/cli/src/app/app.tsx",
        "line": 62,
        "title": "React State Race Condition in handleDiscussReview",
        "description": "In `handleDiscussReview`, the code calls `await session.createSession(title)` and then immediately checks `session.currentSession`. In React, the `session` object (likely from a hook) will not reflect the updated state until the next render cycle. This causes the function to exit early or use a stale session ID when calling the PATCH API.",
        "suggestion": "Modify `createSession` to return the newly created session object directly, and use that return value for the subsequent API request instead of relying on the hook's state."
      },
      {
        "severity": "warning",
        "category": "security",
        "file": "apps/server/src/services/review.ts",
        "line": 90,
        "title": "Potential Prompt Injection via Markdown Fence Escape",
        "description": "The code switched from XML tags to markdown fences (```diff) for the code diff and removed `escapeXml`. If a user includes ` ``` ` inside a code comment or string within the diff, they can break out of the diff context and provide instructions to the LLM. While the prompt instructs the AI to ignore embedded prompts, this is a known vulnerability pattern.",
        "suggestion": "Escape occurrences of triple backticks within the `sanitizedDiff` before injecting it into the prompt, or revert to a more unique XML-like delimiter that is explicitly escaped."
      },
      {
        "severity": "suggestion",
        "category": "style",
        "file": "apps/cli/src/features/review/components/review-display.tsx",
        "line": 9,
        "title": "Inaccurate Scroll Height Estimation",
        "description": "The `estimateContentHeight` function uses a hardcoded divisor of 80 characters to estimate line counts. This does not account for the actual terminal width or long lines of code in issues/suggestions, which will lead to incorrect scroll boundaries (either cutting off content or allowing empty scrolling).",
        "suggestion": "Pass the terminal width (available via Ink's useStdout or a Box ref) to the estimation function, or ideally, use a ref to measure the actual rendered height if possible in the Ink environment."
      },
      {
        "severity": "nitpick",
        "category": "best-practice",
        "file": "apps/server/src/api/routes/review.ts",
        "line": 141,
        "title": "Inconsistent Error Handling in SSE Stream",
        "description": "In the `/stream` route, `saveReview` is called inside a `try...catch` block, but the error is silently ignored. While this prevents the stream from breaking, it might lead to 'lost' history without any server-side logging for diagnostics.",
        "suggestion": "Add a `console.error` in the catch block to log why a review failed to save, even if you don't want to interrupt the user's stream."
      },
      {
        "severity": "nitpick",
        "category": "logic",
        "file": "packages/core/src/ai/providers/gemini.ts",
        "line": 102,
        "title": "Missing Error Propagation on Blocked Content",
        "description": "When Gemini blocks a response (SAFETY, PROHIBITED_CONTENT, etc.), a warning is logged to the console, but `onComplete` is still called with whatever chunks were received (likely empty). The user might see a successful but empty review.",
        "suggestion": "Call `callbacks.onError` with a specific 'Content Blocked' error when the `blocked` flag is true so the UI can display a helpful message."
      }
    ],
    "overallScore": 8
  },
  "gitContext": {
    "branch": "feature/review-bounding",
    "fileCount": 33
  }
}
