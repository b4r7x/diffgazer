# Full Code Audit — 2026-02-06

5 parallel agents, ~130 files audited, ~600 file reads total.
4 fixer agents applied fixes. Build passes clean.

---

## Checklist

### CRITICAL
- [x] C-1. Fix unsafe `as T` cast in SSE parser — `parseEvent` now required
- [x] C-2. Fix unsafe `as ApiError` in resumeReviewStream — safe narrowing
- [x] C-3. Fix unsafe `as ReviewIssue` — IssueFoundEventSchema now uses full ReviewIssueSchema
- [x] C-4. `as ApiError` in client factory — DEFERRED (needs architectural rethink)

### HIGH — useCallback/useMemo removal (React 19 Compiler)
- [x] H-CB-1 through H-CB-43 — ALL DONE (53 useCallback + useMemo removed from 43 files)
- Exception: useMemo kept on Context.Provider values to prevent cascading re-renders

### HIGH — Other
- [x] H-1. Fix diff-view header coloring bug — proper classification for `---`/`+++`/`@@` lines
- [x] H-2. Fix import hierarchy — moved `use-review-history.ts` into `features/history/hooks/`
- [x] H-3. Add feature-level `index.ts` barrel exports (all 5 features)
- [x] H-4. Fix duplicate theme resolution — ThemeStyleApplicator now consumes from context
- [x] H-5. Fix `useApiKeyForm` — added error state + catch blocks

### MEDIUM — Hardcoded colors → TUI tokens
- [x] M-COLOR-1 through M-COLOR-16 — ALL DONE (15 files fixed)

### MEDIUM — Dead code removal
- [x] M-DEAD-1. `truncateToDisplayLength` removed
- [x] M-DEAD-2. `ReviewStreamController` removed
- [ ] M-DEAD-3. `SSEParseResult` — kept (is return type of parseSSEStream)
- [ ] M-DEAD-4. `filtering.ts` functions — kept (used in tests)
- [x] M-DEAD-5. `ConfigSpecificCode`, `ConfigErrorCodeSchema`, `ConfigErrorSchema` removed
- [x] M-DEAD-6. `EventCategorySchema` removed
- [ ] M-DEAD-7. `SHARED_ERROR_CODES` — kept (used internally by createDomainErrorCodes)
- [x] M-DEAD-8. Unused `isMuted` prop removed from `log-entry.tsx`

### MEDIUM — Barrel exports
- [x] M-BARREL-1. `components/shared/index.ts` created
- [x] M-BARREL-2. `hooks/index.ts` created

### MEDIUM — Hooks quality
- [x] M-HOOK-1. Stale closure fixed — boundary checks moved inside setSelectedIndex updater
- [x] M-HOOK-2. Side effects extracted from state updater — uses pendingCallbackRef + useEffect
- [x] M-HOOK-3. Health check — added AbortController + Page Visibility pause
- [x] M-HOOK-4. rAF leak fixed — cancelAnimationFrame on unmount
- [x] M-HOOK-5. Keyboard handler map — scope entries deleted on unregister

### MEDIUM — Misc
- [x] M-MISC-1. `@deprecated` removed from `features/review/types.ts`
- [x] M-MISC-2. `HISTOGRAM_SEVERITIES` fixed to explicit const array
- [x] M-MISC-3. Manual Result construction replaced with `ok(undefined)`
- [ ] M-MISC-4. Duplicate query param building — kept (types differ: string[] vs LensId[])

### LOW — Accessibility
- [x] L-A11Y-1. `severity-filter-button.tsx` — `aria-pressed` added
- [x] L-A11Y-2. `activity-log.tsx` — `aria-hidden` added to cursor
- [x] L-A11Y-3. `run-accordion-item.tsx` — keyboard accessible (role, tabIndex, onKeyDown)

### LOW — Other
- [x] L-1. `params.reviewId!` — fixed with safe narrowing
- [x] L-2. `footer-context.tsx` — removed "q = Quit" from web defaults
- [x] L-3. `config/navigation.ts` — renamed `MenuItem` → `NavItem`
- [x] L-4. Removed all 18 `.passthrough()` from event schemas (all local)

### DEFERRED
- [x] Tests — handled in separate thread
- [x] C-4 ApiError class — needs architectural rethink (not a class)
- [x] try/catch vs Result in hooks — ADR needs scope clarification (try/catch at API boundary is standard in JS ecosystem)
- [x] God hooks — acceptable at current size, split if they grow

---

## Stats

| Category | Total | Fixed | Remaining |
|----------|-------|-------|-----------|
| CRITICAL | 4 | 3 | 1 (deferred) |
| HIGH (useCallback/useMemo) | 43 | 43 | 0 |
| HIGH (other) | 5 | 5 | 0 |
| MEDIUM (colors) | 16 | 16 | 0 |
| MEDIUM (dead code) | 8 | 5 | 3 (intentionally kept) |
| MEDIUM (barrels) | 2 | 2 | 0 |
| MEDIUM (hooks quality) | 5 | 5 | 0 |
| MEDIUM (misc) | 4 | 3 | 1 (intentionally kept) |
| LOW (a11y) | 3 | 3 | 0 |
| LOW (other) | 4 | 4 | 0 |
| **TOTAL** | **94** | **89** | **5** |

**95% fixed. Remaining 5 items are deferred (C-4 ApiError) or intentionally kept (dead code used in tests, internal constants, duplicate query params with different types).**

---

## What's Done Well (unchanged)
- Zero cross-feature imports — perfect isolation
- Thin route files — textbook bulletproof-react
- Keyboard hook system — well-designed, reusable
- Context splitting (ConfigData/ConfigActions) — correct optimization
- Centralized API via @stargazer/api — no direct fetch in features
- Barrel exports on all UI subfolders — consistent
- 100% kebab-case file naming
- Zero `any` types in packages
- Perfect ESM compliance
- `useScopedRouteState` — clever per-route state persistence
- rAF batching in SSE streaming — good optimization
